name: Build APK

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Ù„Ø¶Ù…Ø§Ù† Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©

    # Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙˆÙ…Ù„ÙØ§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    - name: Clean environment
      run: |
        npm cache clean --force
        rm -rf node_modules
        rm -f package-lock.json

    # Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js Ù…Ø¹ ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    # Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª Ø¨Ø¢Ù„ÙŠØ© Ù…ØªØ¯Ø±Ø¬Ø©
    - name: Install dependencies
      run: |
        echo "â³ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… npm ci..."
        npm ci --legacy-peer-deps --prefer-offline || {
          echo "âš ï¸ Fallback Ø¥Ù„Ù‰ npm install...";
          npm install --legacy-peer-deps --force --prefer-offline;
        }
        
        echo "âœ… ØªØ«Ø¨ÙŠØª Capacitor CLI Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§...";
        npm install -g @capacitor/cli

    # Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù„ØªØ­Ù„ÙŠÙ„
    - name: Build project
      run: |
        npm run build 2>&1 | tee build.log || {
          echo "âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡! Ø§Ù„Ø³Ø¬Ù„:";
          cat build.log;
          exit 1;
        }

    # Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Android
    - name: Setup Android environment
      uses: android-actions/setup-android@v3

    # Ø§Ù„Ø®Ø·ÙˆØ© 7: Ù‚Ø¨ÙˆÙ„ ØªØ±Ø§Ø®ÙŠØµ Android ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    - name: Accept Android licenses
      run: |
        yes | sudo $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    # Ø§Ù„Ø®Ø·ÙˆØ© 8: ØªÙ‡ÙŠØ¦Ø© Capacitor
    - name: Initialize Capacitor
      run: |
        npx cap init --yes --web-dir=dist
        npx cap add android

    # Ø§Ù„Ø®Ø·ÙˆØ© 9: Ø¨Ù†Ø§Ø¡ APK Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    - name: Build APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon --max-workers 2

    # Ø§Ù„Ø®Ø·ÙˆØ© 10: Ø±ÙØ¹ APK ÙƒÙ‚Ø·Ø¹Ø© Ø£Ø«Ø±ÙŠØ©
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 1

    # Ø§Ù„Ø®Ø·ÙˆØ© 11: (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
    - name: Notify success
      if: success()
      run: |
        echo "ðŸŽ‰ ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø¨Ù†Ø¬Ø§Ø­!" >> $GITHUB_STEP_SUMMARY
