name: Build APK

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # الخطوة 1: تنزيل الكود من المستودع
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # لضمان جلب كل التاريخ للأخطاء التفصيلية

    # الخطوة 2: تنظيف الذاكرة المؤقتة وملفات الاعتمادات القديمة
    - name: Clean environment
      run: |
        npm cache clean --force
        rm -rf node_modules
        rm -f package-lock.json

    # الخطوة 3: إعداد Node.js مع تمكين التخزين المؤقت
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    # الخطوة 4: تثبيت الاعتمادات بآلية متدرجة
    - name: Install dependencies
      run: |
        echo "⏳ محاولة التثبيت باستخدام npm ci..."
        npm ci --legacy-peer-deps --prefer-offline || {
          echo "⚠️ Fallback إلى npm install...";
          npm install --legacy-peer-deps --force --prefer-offline;
        }
        
        echo "✅ تثبيت Capacitor CLI عالميًا...";
        npm install -g @capacitor/cli

    # الخطوة 5: بناء المشروع مع حفظ السجلات للتحليل
    - name: Build project
      run: |
        npm run build 2>&1 | tee build.log || {
          echo "❌ فشل البناء! السجل:";
          cat build.log;
          exit 1;
        }

    # الخطوة 6: إعداد بيئة Android
    - name: Setup Android environment
      uses: android-actions/setup-android@v3

    # الخطوة 7: قبول تراخيص Android تلقائيًا
    - name: Accept Android licenses
      run: |
        yes | sudo $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    # الخطوة 8: تهيئة Capacitor
    - name: Initialize Capacitor
      run: |
        npx cap init --yes --web-dir=dist
        npx cap add android

    # الخطوة 9: بناء APK مع تحسينات الذاكرة
    - name: Build APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon --max-workers 2

    # الخطوة 10: رفع APK كقطعة أثرية
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 1

    # الخطوة 11: (اختياري) إرسال إشعار عند النجاح
    - name: Notify success
      if: success()
      run: |
        echo "🎉 تم بناء APK بنجاح!" >> $GITHUB_STEP_SUMMARY
